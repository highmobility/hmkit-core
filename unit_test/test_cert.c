//
// Created by Maidu Ule on 30/10/2017.
//

#include "test_cert.h"

#define TEST_NO_MAIN

#include "acutest.h"
#include "hmkit_core_cert.h"
#include "hmkit_core_error.h"

void test_hmkit_core_cert_v0_get_size(void){

    uint8_t accessc_cert_v0[160] = {    0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78, \
                                        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, \
                                        0x11, 0x0A, 0x0A, 0x01, 0x01, \
                                        0x11, 0x0B, 0x0A, 0x01, 0x01, \
                                        0x03, \
                                        0x01, 0x02, 0x03, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78};

    uint16_t size = 0;
    uint8_t result = hmkit_core_cert_get_size(accessc_cert_v0,&size);

    TEST_CHECK_(result == HM_OK, "Result was : %X",result);
    TEST_CHECK_(size == 160, "Size was : %d", size);


}

void test_hmkit_core_cert_v0_get_as_bytes(void){

    uint8_t accessc_cert_v0[160] = {    0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78, \
                                        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, \
                                        0x11, 0x0A, 0x0A, 0x01, 0x01, \
                                        0x11, 0x0B, 0x0A, 0x01, 0x01, \
                                        0x03, \
                                        0x01, 0x02, 0x03, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78};

    hmkit_core_certificate_t  certificate;
    uint8_t result = hmkit_core_cert_get_as_struct(accessc_cert_v0, &certificate);

    TEST_CHECK_(result == HM_OK, "Result was : %X",result);

    uint16_t size = 0;
    uint8_t regen_cert[160];
    memset(regen_cert,0x00,160);

    result =  hmkit_core_cert_get_as_bytes( &certificate, regen_cert, &size);

    TEST_CHECK_(result == HM_OK, "Result was : %X",result);
    TEST_CHECK_(memcmp(accessc_cert_v0,regen_cert,160) == 0, "Regenerated cert data wrong %d", memcmp(accessc_cert_v0,regen_cert,160));
}

void test_hmkit_core_cert_v0_get_as_struct(void){

    uint8_t accessc_cert_v0[160] = {    0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78, \
                                        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, \
                                        0x11, 0x0A, 0x0A, 0x01, 0x01, \
                                        0x11, 0x0B, 0x0A, 0x01, 0x01, \
                                        0x03, \
                                        0x01, 0x02, 0x03, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78};

    hmkit_core_certificate_t  certificate;
    uint8_t result = hmkit_core_cert_get_as_struct(accessc_cert_v0, &certificate);

    TEST_CHECK_(result == HM_OK, "Result was : %X",result);

    TEST_CHECK_(memcmp(&accessc_cert_v0[HMKIT_CORE_CERT_V0_GAINING_SERIAL_POSITION],certificate.gaining_serial,HMKIT_CORE_CERT_SERIAL_SIZE) == 0, "Gaining serial wrong");
    TEST_CHECK_(memcmp(&accessc_cert_v0[HMKIT_CORE_CERT_V0_GAINING_PUBLIC_KEY_POSITION],certificate.public_key,HMKIT_CORE_CERT_PUBLIC_KEY_SIZE) == 0, "Gaining key wrong");
    TEST_CHECK_(memcmp(&accessc_cert_v0[HMKIT_CORE_CERT_V0_PROVIDING_SERIAL_POSITION],certificate.providing_serial,HMKIT_CORE_CERT_SERIAL_SIZE) == 0, "Providing serial wrong");
}

void test_hmkit_core_cert_v1_get_size(void){
    uint8_t accessc_cert_v1[165] = {    0x01, \
                                        0x01, 0x01, 0x01, 0x01, \
                                        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, \
                                        0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78, \
                                        0x11, 0x0A, 0x0A, 0x01, 0x01, \
                                        0x11, 0x0B, 0x0A, 0x01, 0x01, \
                                        0x03, \
                                        0x01, 0x02, 0x03, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78};

    uint16_t size = 0;
    uint8_t result = hmkit_core_cert_get_size(accessc_cert_v1,&size);

    TEST_CHECK_(result == HM_OK, "Result was : %X",result);
    TEST_CHECK_(size == 165, "Size was : %d", size);
}

void test_hmkit_core_cert_v1_get_as_bytes(void){
    uint8_t accessc_cert_v1[165] = {    0x01, \
                                        0x01, 0x01, 0x01, 0x01, \
                                        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, \
                                        0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78, \
                                        0x11, 0x0A, 0x0A, 0x01, 0x01, \
                                        0x11, 0x0B, 0x0A, 0x01, 0x01, \
                                        0x03, \
                                        0x01, 0x02, 0x03, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78};

    hmkit_core_certificate_t  certificate;
    uint8_t result = hmkit_core_cert_get_as_struct(accessc_cert_v1, &certificate);

    TEST_CHECK_(result == HM_OK, "Result was : %X",result);

    uint16_t size = 0;
    uint8_t regen_cert[165];
    memset(regen_cert,0x00,165);

    result =  hmkit_core_cert_get_as_bytes( &certificate, regen_cert, &size);

    TEST_CHECK_(result == HM_OK, "Result was : %X",result);
    TEST_CHECK_(memcmp(accessc_cert_v1,regen_cert,165) == 0, "Regenerated cert data wrong %d", memcmp(accessc_cert_v1,regen_cert,165));
}

void test_hmkit_core_cert_v1_get_as_struct(void){
    uint8_t accessc_cert_v1[165] = {    0x01, \
                                        0x01, 0x01, 0x01, 0x01, \
                                        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, \
                                        0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78, \
                                        0x11, 0x0A, 0x0A, 0x01, 0x01, \
                                        0x11, 0x0B, 0x0A, 0x01, 0x01, \
                                        0x03, \
                                        0x01, 0x02, 0x03, \
                                        0xC8, 0x0C, 0x6B, 0x40, 0x78, 0x8C, 0x63, 0x7A, \
                                        0xC4, 0x7D, 0x2E, 0xAD, 0xF8, 0x96, 0x28, 0x9C, \
                                        0xC6, 0xAB, 0x90, 0xD0, 0x1F, 0xFF, 0x9B, 0x13, \
                                        0x79, 0xAE, 0xBF, 0x2A, 0x6D, 0x6C, 0xA5, 0xFC, \
                                        0x88, 0xD3, 0x48, 0xB7, 0x9E, 0xC1, 0x4F, 0x95, \
                                        0x57, 0x8E, 0xA4, 0x92, 0xA0, 0xE1, 0xDC, 0x13, \
                                        0xC4, 0x27, 0x6A, 0xE1, 0x1E, 0xFE, 0x3E, 0x9A, \
                                        0xB9, 0xFA, 0x67, 0xC3, 0x13, 0x35, 0x47, 0x78};

    hmkit_core_certificate_t  certificate;
    uint8_t result = hmkit_core_cert_get_as_struct(accessc_cert_v1, &certificate);

    TEST_CHECK_(result == HM_OK, "Result was : %X",result);

    TEST_CHECK_(memcmp(&accessc_cert_v1[HMKIT_CORE_CERT_V1_GAINING_SERIAL_POSITION],certificate.gaining_serial,HMKIT_CORE_CERT_SERIAL_SIZE) == 0, "Gaining serial wrong");
    TEST_CHECK_(memcmp(&accessc_cert_v1[HMKIT_CORE_CERT_V1_GAINING_PUBLIC_KEY_POSITION],certificate.public_key,HMKIT_CORE_CERT_PUBLIC_KEY_SIZE) == 0, "Gaining key wrong");
    TEST_CHECK_(memcmp(&accessc_cert_v1[HMKIT_CORE_CERT_V1_PROVIDING_SERIAL_POSITION],certificate.providing_serial,HMKIT_CORE_CERT_SERIAL_SIZE) == 0, "Providing serial wrong");
}